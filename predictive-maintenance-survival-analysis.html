<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>Predictive Maintenance -- Survival Analysis</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Wanda Juan Atom Feed" />
</head>

<body id="index" class="home">
<a href="http://github.com/wanda15tw">
<img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" />
</a>
        <header id="banner" class="body">
                <h1><a href="/">Wanda Juan </a></h1>
                <nav><ul>
                    <li><a href="/pages/about-me.html">About Me</a></li>
                    <li><a href="/pages/project.html">Project</a></li>
                    <li><a href="/category/misc.html">misc</a></li>
                    <li class="active"><a href="/category/python.html">Python</a></li>
                    <li><a href="/category/travel.html">Travel</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/predictive-maintenance-survival-analysis.html" rel="bookmark"
           title="Permalink to Predictive Maintenance -- Survival Analysis">Predictive Maintenance -- Survival Analysis</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2019-12-23T00:00:00-05:00">
                Published: Mon 23 December 2019
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/wanda-juan.html">Wanda Juan</a>
        </address>
<p>In <a href="/category/python.html">Python</a>.</p>
<p>tags: <a href="/tag/python.html">python</a> </p>
</footer><!-- /.post-info -->      <ul>
<li>
<p>View this markdown in <a href="https://github.com/wanda15tw/survival-analysis">github</a>, <a href="https://hackmd.io/@wG5x2COsRkOpxhsHnBO1_A/HJzZ880AS">HackMD</a></p>
</li>
<li>
<p><a href="https://github.com/wanda15tw/survival-analysis/blob/master/1223%20Survival%20Analysis%20-%20confidential%20removed.ipynb">Code in notebook</a></p>
</li>
</ul>
<h6>tags: <code>tech blog</code>, <code>tutorials</code>, <code>predictive maintenance</code>, <code>python</code>, <code>lifelines</code></h6>
<p><a href="https://github.com/wanda15tw/survival-analysis/blob/master/1223%20Survival%20Analysis%20-%20confidential%20removed.ipynb">complete notebook</a></p>
<p><strong>Predictive maintenance</strong> is to predict <em>which machinery at which condition needs preventative maintenance</em> so as to eliminate outages and the costs associated with it. Instead of predicting each individual part's failure, <strong>Survival analysis</strong> is a statistics approach to estimate failure rate. It is also called <strong>reliability analysis</strong> and <strong>event history analysis</strong>. Simply put, it intends to answer -- "How long until an event occurs?"</p>
<p>For example, 
* How long patients survive?
* How long mechanical parts last?</p>
<p>In this tutorial, we exemplify the second question with 28,529 censored parts which had no failure history, 1334 failed parts and their time to event (fail or exit the censorship). Input table is prepared as below with <code>event</code> and <code>time_to_event</code> columns.</p>
<p><img alt="input_table" src="https://i.imgur.com/tUZJwqi.png"></p>
<div class="highlight"><pre><span></span>df.event.value_counts()

# censor    28529
# fail       1334
# Name: event, dtype: int64
</pre></div>


<h2>Kaplan-Meier Estimation</h2>
<p>At each <strong>t + 1</strong>, compute how many <strong>at risk</strong>, which is the last entrance substracted by parts failed at <strong>t</strong> and also those did not fail but monitored until <strong>t</strong> (i.e. # censored) </p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">lifelines</span> <span class="kn">import</span> <span class="n">KaplanMeierFitter</span>

<span class="n">durations</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;time_to_event&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mf">0.5</span> <span class="k">if</span> <span class="n">x</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span> <span class="c1"># workarounds for DOA</span>
<span class="n">event_observed</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;event&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">x</span><span class="o">==</span><span class="s1">&#39;fail&#39;</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">km</span> <span class="o">=</span> <span class="n">KaplanMeierFitter</span><span class="p">()</span>

<span class="n">km</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">durations</span><span class="p">,</span> <span class="n">event_observed</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;KM&#39;</span><span class="p">)</span>
</pre></div>


<ul>
<li>Event Table:</li>
</ul>
<p><code>km.event_table</code></p>
<p><img alt="event_table" src="https://i.imgur.com/r9daMYo.png"></p>
<h2>Survival Function</h2>
<ul>
<li>What fraction survive past t?</li>
<li>e.g., 5-yr survival rates, median survival time</li>
<li>Also called <strong>Reliability Function</strong></li>
</ul>
<p><img alt="survival function" src="https://i.imgur.com/OBTq3Nc.png"></p>
<h3>Estimated by event table</h3>
<p>Survival function can be estimated by the following formula where $d_i$ stands for number of defects/observed and $n_i$ is number of parts entering period $i$ / <strong>at risk</strong>.
<img alt="km survival function" src="https://i.imgur.com/gu15mJ6.png"></p>
<p><code>km.survival_function_</code></p>
<p><img alt="km.survival_function" src="https://i.imgur.com/SeKYnVm.png"></p>
<h2>Hazard Function</h2>
<ul>
<li>Of the people who survive until t, what fraction die at t?</li>
<li>Conditional density probability</li>
</ul>
<p>$$
\lambda(t) = {f(y)\over S(t)}
$$</p>
<ul>
<li>The hazard function might be of more intrinsic interest than the
p.d.f. to a patient who had survived a certain time period and wanted to
know something about their prognosis.</li>
</ul>
<h2>Popular Distributions</h2>
<h3>Weibull</h3>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">lifelines</span> <span class="kn">import</span> <span class="o">*</span> 

<span class="n">wbf</span> <span class="o">=</span> <span class="n">WeibullFitter</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">durations</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">event_observed</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;WeibullFitter&#39;</span><span class="p">)</span>

<span class="n">wbf</span><span class="o">.</span><span class="n">summary</span>
</pre></div>


<p><img alt="" src="https://i.imgur.com/FZpn2YZ.png"></p>
<p><code>wbf.plot_hazard()</code>
<img alt="weibull_hazard" src="https://i.imgur.com/Tu84f6d.png"></p>
<div class="highlight"><pre><span></span>plt.figure(figsize=(10, 24))
plt.subplot(4, 1, 1)
wbf.plot_survival_function()
plt.title(&#39;Survival Curve&#39;)
plt.xlabel(&#39;Time to Event (days)&#39;)
plt.ylabel(&#39;Survival Probability&#39;)

plt.subplot(4, 1, 2)
wbf.plot_cumulative_density()
plt.title(&#39;Cumulative Failure Density&#39;)
plt.xlabel(&#39;Time to Event (days)&#39;)
plt.ylabel(&#39;Cum. Density Prob. (failure)&#39;)


plt.subplot(4, 1, 3)
wbf.plot_hazard()
plt.title(&#39;Hazard Function&#39;)
plt.xlabel(&#39;Time to Event (days)&#39;)
plt.ylabel(&#39;Hazard Function (pdf)&#39;)

plt.subplot(4, 1, 4)
wbf.plot_cumulative_hazard()
plt.title(&#39;Cumulative Hazard Function&#39;)
plt.xlabel(&#39;Time to Event (days)&#39;)
plt.ylabel(&#39;Cumulative Hazard Function&#39;)

plt.show()
</pre></div>


<p><img alt="" src="https://i.imgur.com/vMpKXpj.png"></p>
<h3>QQPlot</h3>
<p>In fact, weibull distribution fits our data poortly, and we can observe that by looking at qqplot as below. None falls on the diagonal line. Instead, Log Normal seems to be a better fit.</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">lifelines.plotting</span> <span class="kn">import</span> <span class="n">qq_plot</span>

<span class="n">durations</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;time_to_event&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mf">0.5</span> <span class="k">if</span> <span class="n">x</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>
<span class="n">event_observed</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;event&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">x</span><span class="o">==</span><span class="s1">&#39;fail&#39;</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">WeibullFitter</span><span class="p">(),</span> <span class="n">LogNormalFitter</span><span class="p">(),</span> <span class="n">LogLogisticFitter</span><span class="p">(),</span> <span class="n">ExponentialFitter</span><span class="p">()]):</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">durations</span><span class="p">,</span> <span class="n">event_observed</span><span class="p">)</span>
    <span class="n">qq_plot</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</pre></div>


<p><img alt="qq_plot" src="https://i.imgur.com/9Iq471K.png"></p>
<h3>LogNormal</h3>
<div class="highlight"><pre><span></span>lnf = LogNormalFitter().fit(durations, event_observed)
lnf.summary
</pre></div>


<p><img alt="" src="https://i.imgur.com/63svVIc.png"></p>
<div class="highlight"><pre><span></span>plt.figure(figsize=(10, 24))
plt.subplot(4, 1, 1)
lnf.plot_survival_function()
plt.title(&#39;Survival Curve&#39;)
plt.xlabel(&#39;Time to Event (days)&#39;)
plt.ylabel(&#39;Survival Probability&#39;)

plt.subplot(4, 1, 2)
lnf.plot_cumulative_density()
plt.title(&#39;Cumulative Failure Density&#39;)
plt.xlabel(&#39;Time to Event (days)&#39;)
plt.ylabel(&#39;Cum. Density Prob. (failure)&#39;)


plt.subplot(4, 1, 3)
lnf.plot_hazard()
plt.title(&#39;Hazard Function&#39;)
plt.xlabel(&#39;Time to Event (days)&#39;)
plt.ylabel(&#39;Hazard Function (pdf)&#39;)

plt.subplot(4, 1, 4)
lnf.plot_cumulative_hazard()
plt.title(&#39;Cumulative Hazard Function&#39;)
plt.xlabel(&#39;Time to Event (days)&#39;)
plt.ylabel(&#39;Cumulative Hazard Function&#39;)

plt.show()
</pre></div>


<p><img alt="" src="https://i.imgur.com/yIc1vip.png"></p>
<h3>Poisson</h3>
<p>Having explored hazard function, which shows unpredictable but extremely low failure rate, it is reasonable to assume the part's failure rate will converge to a constant (random failure in bathtub curve). With that constant failure rate - probability of failure in day, I can convert that to <strong>Mean Time Between Failure (MTBF)</strong> and <strong>Annualized Failure Rate (AFR)</strong>.</p>
<div class="highlight"><pre><span></span># ultimate failure rate
fr = lnf.hazard_.iloc[-1, 0]
MTBF_days = 1/fr
MTBF_mons = round(MTBF_days / 30, 1)
MTBF_yrs = round(MTBF_days / 365, 1)

AFR = fr*365

num_active_parts = 200000
num_active_parts * AFR  # estimated number of failures per year out of 200K active parts
</pre></div>


<p>To fit in a possion distribution, I only need one independent variable. That is average failure rate, and I use AFR multiplied by number of active part base. </p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">poisson</span>

<span class="n">mu</span> <span class="o">=</span> <span class="n">num_active_parts</span> <span class="o">*</span> <span class="n">AFR</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">poisson</span><span class="o">.</span><span class="n">pmf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mu</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Number of failures occur in a year in Prob.&#39;</span><span class="p">)</span>
</pre></div>


<p><img alt="" src="https://i.imgur.com/NLDXu3L.png"></p>
<div class="highlight"><pre><span></span>plt.plot(x, poisson.cdf(x, mu))
plt.title(&#39;Cumu. Demand Distribution (Probability of number of failures less than x)&#39;)
plt.xlabel(&#39;x (demand)&#39;)
plt.show()
</pre></div>


<p><img alt="" src="https://i.imgur.com/1BuH6tk.png"></p>
<div class="highlight"><pre><span></span>i = np.arange(0.01, 1, 0.01)
plt.plot(i, poisson.isf(1-i, mu)) # cdf modified from isf, for some reason, there is no inverse CDF, but inverse survival function
plt.title(&#39;Inverse CDF&#39;)
plt.show()
</pre></div>


<p><img alt="" src="https://i.imgur.com/ooJdvsh.png"></p>
<p>With the cummulative density distribution, I can use its inverse function to map cummulative failure rate back to number of parts that failures migth happen - which is equivalent to the number of spares we would like prepare when a failure happens. </p>
<h2>(Bonus) Spares Demand Forecast using Newsvendor Model</h2>
<h3>Newsvendor Model</h3>
<p>The optimal spare quantiy given underage cost $C_u$ and overage cost $C_o$ is to minimize expected overall cost:
To minize:
$$
Expected\ Overage\ Cost + Expected\ Underage\ Cost\ \
= E(Demand<Q)\times C_o + E(Demand>Q) \times C_u \
$$</p>
<p>Equals to derivative = 0, equals to
$$
P(Demand&lt;Q<em>) = {C_u\over C_u+C_o} \
==Q</em> = F^{-1}({C_u \over C_u+C_o})
$$</p>
<h2>Results</h2>
<div class="highlight"><pre><span></span>SLAs = [0.50, 0.75, 0.95, 0.96, 0.97, 0.98, 0.99, 0.9999999, 1]
print(&#39;{:&lt;30}{:&lt;40}&#39;.format(&#39;Reliability&#39;, &#39;# Spares&#39;))
for sla in SLAs:
    print(&#39;{:&lt;30}{:&lt;40}&#39;.format(sla, poisson.isf(1-sla, mu)))
</pre></div>


<p><img alt="" src="https://i.imgur.com/ypUvju4.png"></p>
<p>This simplified model (constant failure rate = 0.0003 per day / AFR = 203 per year) fitted in poisson distribution recommends 237 spares in a year to achieve 99% reliability or when ${C_u\over C_u+C_o} = 0.99$.</p>
<h2>Reference</h2>
<ul>
<li>https://www.youtube.com/watch?v=XHYFNraQEEo</li>
<li>https://towardsdatascience.com/survival-analysis-intuition-implementation-in-python-504fde4fcf8e</li>
<li>https://lifelines.readthedocs.io/en/latest/Quickstart.html</li>
</ul>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>