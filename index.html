<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>Wanda Juan</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Wanda Juan Atom Feed" />
</head>

<body id="index" class="home">
<a href="http://github.com/wanda15tw">
<img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" />
</a>
        <header id="banner" class="body">
                <h1><a href="/">Wanda Juan </a></h1>
                <nav><ul>
                    <li><a href="/pages/about-me.html">About Me</a></li>
                    <li><a href="/pages/project.html">Project</a></li>
                    <li><a href="/category/misc.html">misc</a></li>
                    <li><a href="/category/project.html">Project</a></li>
                    <li><a href="/category/python.html">Python</a></li>
                    <li><a href="/category/travel.html">Travel</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="/predictive-maintenance-survival-analysis.html">Predictive Maintenance -- Survival Analysis</a></h1>
<footer class="post-info">
        <abbr class="published" title="2019-12-23T00:00:00-05:00">
                Published: Mon 23 December 2019
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/wanda-juan.html">Wanda Juan</a>
        </address>
<p>In <a href="/category/project.html">Project</a>.</p>
<p>tags: <a href="/tag/python.html">python</a> </p>
</footer><!-- /.post-info --><details>
    <summary>
* View this markdown in [github](https://github.com/wanda15tw/survival-analysis), [HackMD](https://hackmd.io/@wG5x2COsRkOpxhsHnBO1_A/HJzZ880AS)

* [Code in notebook](https://github.com/wanda15tw/survival-analysis/blob/master/1223%20Survival%20Analysis%20-%20confidential%20removed.ipynb)


###### tags: `tech blog`, `tutorials`, `predictive maintenance`, `python`, `lifelines`
[complete notebook](https://github.com/wanda15tw/survival-analysis/blob/master/1223%20Survival%20Analysis%20-%20confidential%20removed.ipynb)

**Predictive maintenance** is to predict *which machinery at which condition needs preventative maintenance* so as to eliminate outages and the costs associated with it. Instead of predicting each individual part's failure, **Survival analysis** is a statistics approach to estimate failure rate. It is also called **reliability analysis** and **event history analysis**. Simply put, it intends to answer -- "How long until an event occurs?"
</summary>

For example, 
* How long patients survive?
* How long mechanical parts last?

In this tutorial, we exemplify the second question with 28,529 censored parts which had no failure history, 1334 failed parts and their time to event (fail or exit the censorship). Input table is prepared as below with `event` and `time_to_event` columns.

![input_table](https://i.imgur.com/tUZJwqi.png)


<div class="highlight"><pre><span></span>df.event.value_counts()

# censor    28529
# fail       1334
# Name: event, dtype: int64
</pre></div>


## Kaplan-Meier Estimation
At each **t + 1**, compute how many **at risk**, which is the last entrance substracted by parts failed at **t** and also those did not fail but monitored until **t** (i.e. # censored) 

<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">lifelines</span> <span class="kn">import</span> <span class="n">KaplanMeierFitter</span>

<span class="n">durations</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;time_to_event&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mf">0.5</span> <span class="k">if</span> <span class="n">x</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span> <span class="c1"># workarounds for DOA</span>
<span class="n">event_observed</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;event&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">x</span><span class="o">==</span><span class="s1">&#39;fail&#39;</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">km</span> <span class="o">=</span> <span class="n">KaplanMeierFitter</span><span class="p">()</span>

<span class="n">km</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">durations</span><span class="p">,</span> <span class="n">event_observed</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;KM&#39;</span><span class="p">)</span>
</pre></div>


* Event Table:

`km.event_table`

![event_table](https://i.imgur.com/r9daMYo.png)




## Survival Function
* What fraction survive past t?
* e.g., 5-yr survival rates, median survival time
* Also called **Reliability Function**

![survival function](https://i.imgur.com/OBTq3Nc.png)

### Estimated by event table 
Survival function can be estimated by the following formula where $d_i$ stands for number of defects/observed and $n_i$ is number of parts entering period $i$ / **at risk**.
![km survival function](https://i.imgur.com/gu15mJ6.png)

`km.survival_function_`

![km.survival_function](https://i.imgur.com/SeKYnVm.png)

## Hazard Function
* Of the people who survive until t, what fraction die at t?
* Conditional density probability

$$
\lambda(t) = {f(y)\over S(t)}
$$

* The hazard function might be of more intrinsic interest than the
p.d.f. to a patient who had survived a certain time period and wanted to
know something about their prognosis.

## Popular Distributions
### Weibull


<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">lifelines</span> <span class="kn">import</span> <span class="o">*</span> 

<span class="n">wbf</span> <span class="o">=</span> <span class="n">WeibullFitter</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">durations</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">event_observed</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;WeibullFitter&#39;</span><span class="p">)</span>

<span class="n">wbf</span><span class="o">.</span><span class="n">summary</span>
</pre></div>


![](https://i.imgur.com/FZpn2YZ.png)

`wbf.plot_hazard()`
![weibull_hazard](https://i.imgur.com/Tu84f6d.png)


<div class="highlight"><pre><span></span>plt.figure(figsize=(10, 24))
plt.subplot(4, 1, 1)
wbf.plot_survival_function()
plt.title(&#39;Survival Curve&#39;)
plt.xlabel(&#39;Time to Event (days)&#39;)
plt.ylabel(&#39;Survival Probability&#39;)

plt.subplot(4, 1, 2)
wbf.plot_cumulative_density()
plt.title(&#39;Cumulative Failure Density&#39;)
plt.xlabel(&#39;Time to Event (days)&#39;)
plt.ylabel(&#39;Cum. Density Prob. (failure)&#39;)


plt.subplot(4, 1, 3)
wbf.plot_hazard()
plt.title(&#39;Hazard Function&#39;)
plt.xlabel(&#39;Time to Event (days)&#39;)
plt.ylabel(&#39;Hazard Function (pdf)&#39;)

plt.subplot(4, 1, 4)
wbf.plot_cumulative_hazard()
plt.title(&#39;Cumulative Hazard Function&#39;)
plt.xlabel(&#39;Time to Event (days)&#39;)
plt.ylabel(&#39;Cumulative Hazard Function&#39;)

plt.show()
</pre></div>


![](https://i.imgur.com/vMpKXpj.png)


### QQPlot

In fact, weibull distribution fits our data poortly, and we can observe that by looking at qqplot as below. None falls on the diagonal line. Instead, Log Normal seems to be a better fit.


<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">lifelines.plotting</span> <span class="kn">import</span> <span class="n">qq_plot</span>

<span class="n">durations</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;time_to_event&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mf">0.5</span> <span class="k">if</span> <span class="n">x</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>
<span class="n">event_observed</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;event&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">x</span><span class="o">==</span><span class="s1">&#39;fail&#39;</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">WeibullFitter</span><span class="p">(),</span> <span class="n">LogNormalFitter</span><span class="p">(),</span> <span class="n">LogLogisticFitter</span><span class="p">(),</span> <span class="n">ExponentialFitter</span><span class="p">()]):</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">durations</span><span class="p">,</span> <span class="n">event_observed</span><span class="p">)</span>
    <span class="n">qq_plot</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</pre></div>


![qq_plot](https://i.imgur.com/9Iq471K.png)

### LogNormal


<div class="highlight"><pre><span></span>lnf = LogNormalFitter().fit(durations, event_observed)
lnf.summary
</pre></div>


![](https://i.imgur.com/63svVIc.png)


<div class="highlight"><pre><span></span>plt.figure(figsize=(10, 24))
plt.subplot(4, 1, 1)
lnf.plot_survival_function()
plt.title(&#39;Survival Curve&#39;)
plt.xlabel(&#39;Time to Event (days)&#39;)
plt.ylabel(&#39;Survival Probability&#39;)

plt.subplot(4, 1, 2)
lnf.plot_cumulative_density()
plt.title(&#39;Cumulative Failure Density&#39;)
plt.xlabel(&#39;Time to Event (days)&#39;)
plt.ylabel(&#39;Cum. Density Prob. (failure)&#39;)


plt.subplot(4, 1, 3)
lnf.plot_hazard()
plt.title(&#39;Hazard Function&#39;)
plt.xlabel(&#39;Time to Event (days)&#39;)
plt.ylabel(&#39;Hazard Function (pdf)&#39;)

plt.subplot(4, 1, 4)
lnf.plot_cumulative_hazard()
plt.title(&#39;Cumulative Hazard Function&#39;)
plt.xlabel(&#39;Time to Event (days)&#39;)
plt.ylabel(&#39;Cumulative Hazard Function&#39;)

plt.show()
</pre></div>


![](https://i.imgur.com/yIc1vip.png)

### Poisson 
Having explored hazard function, which shows unpredictable but extremely low failure rate, it is reasonable to assume the part's failure rate will converge to a constant (random failure in bathtub curve). With that constant failure rate - probability of failure in day, I can convert that to **Mean Time Between Failure (MTBF)** and **Annualized Failure Rate (AFR)**.


<div class="highlight"><pre><span></span># ultimate failure rate
fr = lnf.hazard_.iloc[-1, 0]
MTBF_days = 1/fr
MTBF_mons = round(MTBF_days / 30, 1)
MTBF_yrs = round(MTBF_days / 365, 1)

AFR = fr*365

num_active_parts = 200000
num_active_parts * AFR  # estimated number of failures per year out of 200K active parts
</pre></div>



To fit in a possion distribution, I only need one independent variable. That is average failure rate, and I use AFR multiplied by number of active part base. 



<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">poisson</span>

<span class="n">mu</span> <span class="o">=</span> <span class="n">num_active_parts</span> <span class="o">*</span> <span class="n">AFR</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">poisson</span><span class="o">.</span><span class="n">pmf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mu</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Number of failures occur in a year in Prob.&#39;</span><span class="p">)</span>
</pre></div>


![](https://i.imgur.com/NLDXu3L.png)

<div class="highlight"><pre><span></span>plt.plot(x, poisson.cdf(x, mu))
plt.title(&#39;Cumu. Demand Distribution (Probability of number of failures less than x)&#39;)
plt.xlabel(&#39;x (demand)&#39;)
plt.show()
</pre></div>


![](https://i.imgur.com/1BuH6tk.png)




<div class="highlight"><pre><span></span>i = np.arange(0.01, 1, 0.01)
plt.plot(i, poisson.isf(1-i, mu)) # cdf modified from isf, for some reason, there is no inverse CDF, but inverse survival function
plt.title(&#39;Inverse CDF&#39;)
plt.show()
</pre></div>


![](https://i.imgur.com/ooJdvsh.png)


With the cummulative density distribution, I can use its inverse function to map cummulative failure rate back to number of parts that failures migth happen - which is equivalent to the number of spares we would like prepare when a failure happens. 


## (Bonus) Spares Demand Forecast using Newsvendor Model

### Newsvendor Model
The optimal spare quantiy given underage cost $C_u$ and overage cost $C_o$ is to minimize expected overall cost:
To minize:
$$
Expected\ Overage\ Cost + Expected\ Underage\ Cost\ \\
= E(Demand<Q)\times C_o + E(Demand>Q) \times C_u \\
$$

Equals to derivative = 0, equals to
$$
P(Demand<Q*) = {C_u\over C_u+C_o} \\
==Q* = F^{-1}({C_u \over C_u+C_o})
$$

## Results

<div class="highlight"><pre><span></span>SLAs = [0.50, 0.75, 0.95, 0.96, 0.97, 0.98, 0.99, 0.9999999, 1]
print(&#39;{:&lt;30}{:&lt;40}&#39;.format(&#39;Reliability&#39;, &#39;# Spares&#39;))
for sla in SLAs:
    print(&#39;{:&lt;30}{:&lt;40}&#39;.format(sla, poisson.isf(1-sla, mu)))
</pre></div>


![](https://i.imgur.com/ypUvju4.png)

This simplified model (constant failure rate = 0.0003 per day / AFR = 203 per year) fitted in poisson distribution recommends 237 spares in a year to achieve 99% reliability or when ${C_u\over C_u+C_o} = 0.99$.


## Reference
* https://www.youtube.com/watch?v=XHYFNraQEEo
* https://towardsdatascience.com/survival-analysis-intuition-implementation-in-python-504fde4fcf8e
* https://lifelines.readthedocs.io/en/latest/Quickstart.html

</details>                </article>
            </aside><!-- /#featured -->
                <section id="content" class="body">
                    <h1>Other articles</h1>
                    <hr />
                    <ol id="posts-list" class="hfeed">

            <li><article class="hentry">
                <header>
                    <h1><a href="/first-python-post.html" rel="bookmark"
                           title="Permalink to First Python Post">First Python Post</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2019-12-06T00:00:00-05:00">
                Published: Fri 06 December 2019
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/wanda-juan.html">Wanda Juan</a>
        </address>
<p>In <a href="/category/python.html">Python</a>.</p>
<p>tags: <a href="/tag/python.html">python</a> </p>
</footer><!-- /.post-info -->                <p>Python 101</p>
                <a class="readmore" href="/first-python-post.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="/first-travel-post.html" rel="bookmark"
                           title="Permalink to First Travel Post">First Travel Post</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2019-12-06T00:00:00-05:00">
                Published: Fri 06 December 2019
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/wanda-juan.html">Wanda Juan</a>
        </address>
<p>In <a href="/category/travel.html">Travel</a>.</p>
<p>tags: <a href="/tag/travel.html">travel</a> <a href="/tag/europe.html">europe</a> <a href="/tag/italy.html">italy</a> </p>
</footer><!-- /.post-info -->                <p>2016 Italy trip</p>
                <a class="readmore" href="/first-travel-post.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="/Welcome.html" rel="bookmark"
                           title="Permalink to Welcome to my blog">Welcome to my blog</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2019-11-23T00:00:00-05:00">
                Published: Sat 23 November 2019
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/wanda-juan.html">Wanda Juan</a>
        </address>
<p>In <a href="/category/misc.html">misc</a>.</p>

</footer><!-- /.post-info -->                <h1>Welcome to my blog</h1>
<p>This is my first post on my new blog. While not super informative it
should convey my sense of excitement and eagerness to engage with you,
the reader!</p>
                <a class="readmore" href="/Welcome.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="/my-super-post.html" rel="bookmark"
                           title="Permalink to My super title">My super title</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2010-12-03T10:20:00-05:00">
                Published: Fri 03 December 2010
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/wanda-juan.html">Wanda Juan</a>
        </address>
<p>In <a href="/category/python.html">Python</a>.</p>
<p>tags: <a href="/tag/pelican.html">pelican</a> <a href="/tag/publishing.html">publishing</a> </p>
</footer><!-- /.post-info -->                <p>Short version for index and feeds</p>
                <a class="readmore" href="/my-super-post.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>
                </ol><!-- /#posts-list -->
                </section><!-- /#content -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>